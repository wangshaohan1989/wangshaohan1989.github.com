# 微服务架构设计之OAuth2.0，OpenID，安全，Spring Security

## 一、Web API授权：OAuth2.0协议
###   （一）OAuth2.0的用途
>OAuth2协议是一个安全协议，用于保护Web API.它用于连接不同的网站、系统，还支持原生应用和移动应用于与云服务之间的连接。OAuth2能让第三方应用以有限的权限访问，HTTP服务，可以通过构建资源拥有者与HTTP服务间的许可交互机制，让第三方应用代表资源拥有者访问服务或者通过授予权限给第三方应用，让其代表自己访问服务。简单的说，OAuth2是一个授权框架，它关注的是如何让一个系统组件获取另外一个系统组件的访问权限。

>实质是它将用户的身份认证、授权与客户端的身份认证分离，保证各系统组件间交互的安全性。

### （二）OAuth2.0 授权流程：
#### （1）授权码模式
![OAuth2.0授权模式交互过程](/img/postImgs/Oauth2process.png)
* **步骤0：客户端系统备案**
客户端注册实例，获取客户端ID（client_id）和客户端秘钥（client_secret）标识客户端的身份，用于客户端向授权服务器请求授权时的进行身份认证的凭据。未经系统备案的客户端，授权服务器禁止为其发放授权码、访问令牌等，也访问不了受保护的资源服务器。
* **步骤1: 委托**   （资源拥有者  -> 客户端）
> 资源拥有者授权指定客户端访问指定资源
* **步骤2：发起授权请求**    （客户端->授权服务器）
* **步骤3： 用户身份认证**   （资源拥有者->授权服务器）
* **步骤4：授权**     （资源拥有者->客户端）
* **步骤5：发放授权码**（授权服务器->客户端） 
* **步骤6：客户端身份认证**（客户端->授权服务器）
* **步骤7：发放令牌access_token**（授权服务器->客户端） 
* **步骤8：出示令牌,访问受保护资源**（授权服务器->客户端） 


#### （2）隐藏式模式
![隐藏式模式](/img/postImgs/Oauth2Implicit.png)

* **步骤1:委托** （资源拥有者  -> 客户端）
* **步骤2:用户导向** （客户端->授权服务器）将用户导向授权服务器用户认证端点
* **步骤3:用户身份认证** （资源拥有者->授权服务器）
* **步骤4：授权**     （资源拥有者->客户端）
* **步骤5:发放令牌** 将用户重定向至客户端并返回令牌
> 在重定向uri的Hash部分带有令牌
* **步骤6:** 客户端通过浏览器访问受保护资源（资源服务器）
> 不带Hash部分的令牌
* **步骤7:** 资源服务器返回一个网页（一份脚本）给浏览器，脚本用于获取令牌
* **步骤8:** 浏览器执行脚本，从Hash中提取令牌返回给客户端.




#### （3）密码式模式
![密码模式](/img/postImgs/Oauth2password.png)
* **步骤1:用户直接向客户端提供账号信息** （资源拥有者  -> 客户端）
* **步骤2:客户端代替用户与授权服务器进行用户身份人** （客户端->授权服务器）
* **步骤3:发放令牌** （授权服务器->客户端）
>重定向至客户端并带上令牌

#### （4）客户端凭证模式
![客户端凭证模式](/img/postImgs/Oauth2client.png)
* **用户在客户端上注册** （资源拥有者  -> 客户端）
* **客户端身份认证** （客户端->授权服务器）
  >不是用户身份认证
* **发放令牌** （授权服务器->客户端）


### （三）OAuth2.0中的角色和组件
#### 1、OAuth2.0中的角色
* 资源拥有者：一般是一个人，一个用户；
* 客户端 ：通常指浏览器；
* 授权服务器（新引入）：资源服务器访问的授权中心；
* 资源服务器：存储资源拥有者（用户）的数据，也是客户端要申请访问的内容
#### 2、OAuth2.0中的组件
* **授权许可code（授权码）：** 用在基于重定向的授权流程中使用。一个授权码只能用一次，而且最多存活10分钟。
* **访问令牌access_token ：** 用于访问受保护资源的一个短期令牌。
* 刷新令牌refresh_token
* 权限范围scope

#### 3、令牌的类型
* Bearer Token
* MAC
* JSON Web Token

##### （1）令牌使用的三种不同方式:
令牌存放位置 | 示例 | 备注
-|-|-|
请求首部中提供 |Authorization:Bearer 4ae6ce86-xxxxxxx-xxxx | 推荐方式
请求体中提供 | access_token | 请求首部中Content-Type必须设置为application/x-wwww-form-urlencoded
请求URL中 | http://xxxx?xxxx=|Cache-Control=no-store，不推荐使用
##### （2）令牌的生成
* 必须唯一
* 不连续
* 无法猜测出

### （四）授权码模式举例说明：使用微博登陆知乎
1、知乎登陆页面选择微博登陆（用户授权使用微博账号登陆知乎）
2、客户端（这里是知乎）向授权服务器（微博）发起授权请求
3、跳转到微博输入账号和密码的页面（用户身份认证）
4、输入微博账号密码后跳转到客户端页面（授权）
5、发放授权码
6、请求访问令牌，客户端身份认证
7、授权服务器（微博）向客户端发放访问令牌
8、客户端出示访问令牌向资源服务器（微博的）请求资源（头像，昵称，联系方式等）

### （五）OAuth2.0的四种授权模式与使用场景：
#### 1、客户端四种授权模式
* （1）授权码模式：
  >第三方应用（客户端）先申请授权码然后在使用授权码申请访问令牌.最常用的、也是最安全的授权方式，适用于有后端的Web应用。是为了避免共享资源拥有者的凭据而使用的中间令牌。

  >特点：
      1）授权码通过前端进行发放（授权服务器-->客户端）
      2）令牌存储在后端
      3）功能最完整，流程最严密的授权模式

  >适用场景：给运行在Web服务器上的应用使用

* （2）隐藏式模式：未验证客户端身份
   >不通过第三方应用，直接由浏览器向授权服务器发起令牌申请，跳过授权码
   >特点:
      1)所有步骤在浏览器中完成，访问者对令牌可见，
      2)客户端不需要进行身份认证
      3）少了获取授权码code的步骤，是直接获取令牌token的，适用于公开的浏览器单页应用，令牌直接从授权服务器返回，不支持刷新令牌，且没有code安全保证，令牌容易因为被拦截窃听而泄露

   >适用场景：给浏览器和客户端使用，适用于公开的浏览器单页应用
  
* （3）密码式模式（资源拥有者的凭据）：
  >用户直接向客户端提供用户名和密码，由客户端根据用户提供的账号信息向授权服务器进行用户身份认证并获取访问令牌。最后通过访问令牌向资源服务器请求资源。

  >特点：不安全，用户账号信息直接暴露给客户端

  >适用场景：其他授权模式不可用的情况下使用，或者高度信任的情况下使用
  
* （4）客户端凭证模式：客户端同时也是资源拥有者

  >特点：
        1）不存在授权问题
        2）用户与授权服务器不进行身份认证
        3）客户端与授权服务器进行客户端身份认证
  
  >适用场景：提供给应用访问资源





### （六）OAuth2.0实现细节

#### 1、OAuth客户端的实现
##### （1）客户端用户导向处理（用户授权客户端访问）
   【授权码模式，隐藏式模式】
用户访问客户端，客户端将用户导向授权服务器用户身份认证端点
客户端申请用户认证请求的参数：
请求参数|参数作用|是否必传|备注
-|-|-|-
response_type|表示授权类型|是|授权码模式时为"code"，隐藏式模式时为“token“
client_id|表示客户端的ID|是|客户端注册的时候发放
redirect_uri|表示重定向URI|否|授权服务器将用户导向回客户端指定的url并附上授权码
scope|表示申请的权限范围|否|
state|表示客户端的当前状态，用于防范跨站请求伪造CSRF|否|可以指定任意值，认证服务器会原封不动地返回这个值

备注：紧接着有授权服务器响应授权请求[(六)->3->(1)->2)]
##### （2）客户端收到授权码后发起令牌申请
【授权码模式】
客户端令牌申请请求参数：
请求参数|作用|是否必传|备注
-|-|-|-
grant_type|表示使用的授权模式|是|授权码模式时为"authorization_code"。
code|表示上一步获得的授权码|是|授权服务器用户身份认证通过后返回给客户端的授权码
redirect_uri|表示重定向URI|是|必须与上述”客户端用户导向处理“步骤中的该参数值保持一致。
client_id|表示客户端ID|是|唯一表示一个客户端

备注：HTTP头部设置
Authorization: Basic xxxxxxxxxxxxxxxxxxxxxxxx
Content-Type: application/x-www-form-urlencoded
##### （3）客户端身份认证
【客户端凭证模式】
客户端向授权服务器发起认证请求：
请求参数|是否必传|参数作用|备注
-|-|-|-
granttype|是|表示授权类型|此处的值固定为"clientcredentials"
scope|否|表示权限范围|
备注:HTTP头部设置：
 Authorization: Basic xxxxxxxxxxxxxxxxxxxxxxxx
 Content-Type: application/x-www-form-urlencoded

##### （4）客户端根据用户提供的账号信息和授权服务器进行用户身份认证
客户端请求参数：
请求参数|是否必传|参数作用|备注
-|-|-|-
grant_type|是|表示授权类型|此处的值固定为"password"。
username|是|表示用户名|
password|是|表示用户的密码。|
scope|否|表示权限范围|

##### （5）客户端使用刷新令牌
客户端向授权服务器发起更新令牌的请求：
请求参数|是否必传|参数作用|备注
-|-|-|-
granttype|是|表示使用的授权模式|此处的值固定为"refreshtoken"。
refresh_token|是|表示早前收到的更新令牌|
scope|否|表示申请的授权范围|不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致
#### 2、受保护资源的实现
##### 1）处理资源请求：


#### 3、 授权服务器的实现

##### （1）授权端点（/authorize）
###### 1）生成授权码
一个授权码只能用一次，而且最多存活10分钟。
具有唯一性、不连续性、不易猜测性


###### 2）响应授权请求：（客户端将用户导向授权服务器的处理）
【授权码模式】
响应参数 |是否必传|参数作用|备注
-|-|-|-
code|是|表示授权码，绑定客户端重定向URL和标识符的访问权限|有效期通常为10分钟，客户端只能使用一次，否则将被授权服务器拒绝。
state|是|用于防范跨站请求伪造CSRF|将客户端请求的原翻不动传递回去
##### （2）令牌端点（/token）

###### 1）生成令牌 

###### 2）响应令牌请求（向客户端发放令牌）：
【授权码模式，隐藏式模式，密码模式，客户端凭证模式】
响应参数 |是否必传|参数作用|备注
-|-|-|-
access_token|是|授权服务器签发的访问令牌
token_type|是|表示令牌类型，告知客户端如何利用访问令牌请求资源|该值大小写不敏感,可以是bearer类型或mac类型
expires_in|推荐|存活时间（秒）|
scope|可选|表示权限访问|与客户端申请的一致
refresh_token|可选|更新令牌，使用相同的授权许可刷新访问令牌|隐藏式模式和客户端凭证模式下没有刷新令牌

备注：参数使用JSON格式发送。此外，HTTP头信息中明确指定不得缓存。
HTTP请求头部：Content-Type: application/json
            Cache-Control:no-cache



##### （3）用户端点（/userInfo)



##### （3）刷新令牌


#### 4、错误的处理
##### （1）相关HTTP错误代码
状态码|名称|说明
-|-|-
302|Found|用户代理一定不能自动重定向，可以在授权请求路由中使用
400|Bad Request|恶意请求
401|Unauthorized|身份验证失败或未提供身份验证信息。响应首部必须包含WWW-Authenticate
403|Forbidden|通过身份验证，但是未获得资源的授权
500|Internal Server Error|服务器无法处理请求
503|Service Unavailable |服务器可能过载，目前无法处理请求
##### （2）OAuth错误代码



### （七）OAuth2的安全与漏洞

## 二、Web身份认证：OpenID+OAuth2构建身份认证体系

> OpenID Connect： OpenID基金会在2014年发布的一个身份验证标准，基于OAuth2.0核心之上增加了一层，通过类似REST的标准化方式处理用户身份验证。传送的数据都是JSON格式。规范核心是ID令牌。ID令牌作为安全令牌，并且包含身份验证信息。它使用JSON WEB Signature （JWS)签署也可以使用JSON Web Encryption (JWE)进行加密。

### （一）ID令牌
ID令牌的基本内容：
参数|作用|必要性
-|-|-
iss|签发方标识符,以URL形式指明，使用https模式|必须
sub|使用者标识符|必须
aud|ID令牌的受众，必须包含OAuth client_id|必须
exp|过期时间|必须
iat|令牌签发时间|必须
nonce||
auth_time|验证用户身份的时间|可选
acr|身份验证上下文类引用|可选
amr|身份验证方法引用|可选
azp|授权方，必须包含OAuth client_id|可选

OpenID Connect令牌是JSON Web Token，必须使用JWS签名，随后可以选用JWS和JWE签名和加密

### （二）用户信息端点（/UserInfo)：
/userinfo端点接受到的所有请求多要使用Authorization首部中的访问令牌签名。

### （三）授权端点的处理：
scope参数：传入openid
授权端点验证scope是否包含openid

### （四）令牌端点的处理：
1、验证许可类型（授权码）是否为OpenID Connect身份验证请求的结果。
>如果是则返回ID令牌，否则不返回ID令牌。

验证过程：
（1）scope参数内是否包含openid
（2）包含，则创建新的ID令牌连同访问令牌、刷新令牌等一并返回
（3）不包含，走授权请求流程。
 


## 三、Web数据安全
### （一）窃取用户账户访问权的方式：
#### 1、暴力攻击
>暴力攻击，又称穷举键搜索，指遍历给定长度下的所有可能的密码排列，尝试破解加密密码的操作。

特点：
> 1）耗时较长
> 2）用于破解离线数据，即用于攻击网站后破解下载后的数据

防范和规避：
> 1）登陆控制，使用用户名+密码+验证码的方式登陆，增加登陆难度，防范自动登陆攻击
> 2）使用双因素身份验证机制（2FA），如通过短信验证码验证电话号码

#### 2、字典攻击
> 字典攻击：从字典的所有词和常见的密码中选词，加密后与得到的用户的加密密码进行不断的比较，直至匹配成功。

防范和规避：
> 密码不仅要加密，而且还要加盐。

#### 3、彩虹表
>与哈希单向算法相反，哈希是将用户的明文密码编码成一串哈希值。而彩虹表是把哈希值映射到对应的明文密码上。

防范和规避：
>加盐

#### 4、反向查询表
> 与字典攻击类似，但是不仅存储了密码的明文还存储了相应的哈希值，降低了解密耗费的时间。并且是按照哈希值搜索的，不同于字典攻击的按照明文密码搜索。

防范和规避：
>计算密码的哈希值时加盐



### （二）密码加密和安全性
#### 1、静态数据和动态数据
> 静态数据：是指不活动的或者静止的数据（用户密码、用户个人资料等），存储在服务器的数据库中。

数据库使用的加密算法：
> 1）强加密算法：SHA-256，AES,RSA （应该用于数据库）
> 2）弱加密算法：MD5,SHA-1（不能用于加密数据库）

静态数据安全性操作规范：
>1）把访问控制（用户登陆）和数据加密分开，
2）用于加密数据库的密钥要定期更新
3）加密密钥应该与数据分开存储


> 动态数据：是指用于传输中的数据，在应用和数据库之间来回传送，或者在网站和API或外部数据源之间来回传送。

#### 2、加盐
##### （1）加盐的含义：
>通过生成一串盐值，一种随机数据，用于计算密码的哈希值时使用，确保生成的哈希值时唯一的，即时相关的用户名和密码，添加唯一的盐值后能确保得到的哈希值仍是唯一的。加强了数据的安全性和抵御多种攻击媒介。

##### （2）生成随机盐值
Node项目使用crypto库

##### （3）盐值的使用：
>1）盐值的重用：不同的用户名密码使用不同的盐值
>2）盐值的长度：盐值的长度和哈希函数得出的哈希值长度一致，多数情况下使用128位（16字节）
>3）盐值的存储：和哈希值一起以明文的方式存储在数据库中

#### 3、三个哈希函数
<style>
table th:nth-of-type(1){
width: 10%;
}
table th:nth-of-type(2){
width: 60%
;
}
table th:nth-of-type(3){
width: 20%;
}
</style>

哈希函数 | 特点 | 破解的资源消耗
-|-|-
bcrypt | 1、专门为密码设计的哈希算法，故意放慢速度；2、基于Blowfinsh密码法 | 少量硬件资源上实施几千次攻击即可
PBKDF2 | 1、经受住时间的考验；2、众多推荐算法 | 少量硬件资源上实施几千次攻击即可
scrypt | 1、做了特殊设计，是硬件和内存密集型算法；2、是加密数字货币等背后采用的算法 | 攻击者需要实施大型攻击

#### 4、密钥延伸
>密钥延伸：把弱密码变成特别复杂的长密码，致使暴力攻击等媒介不再可行。
对加密函数来说，密钥延伸体现在不断循环应用哈希函数直到得到所需长度和复杂度的哈希值为止。


### （三）数据传输安全


## 四、 Web应用安全
### （1）保护会话
### （2）XSS
### （3）CSRF
### 
## 五、Spring Security OAuth





## 六、参考文献
1、《OAuth2实战》
2、阮一峰的网络日志   《OAuth 2.0 的一个简单解释》http://www.ruanyifeng.com/blog/2019/04/oauth_design.html
http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html
3、《Web开发的身份和数据安全》
4、《Spring Security框架实战》 
5、RFC OAuth2.0规范 http://www.rfcreader.com/#rfc6749
